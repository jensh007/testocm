name: add-cert
# trigger manually
run-name: Create certificate
on:
  workflow_dispatch:
jobs:
  create-cert:
    runs-on: ubuntu-latest
    steps:
    - name: create-cert
      run: |
        HNAME=`hostname --fqdn`
        echo "pwd is: $PWD"
        echo "fwdn hostame is: $HNAME"
        mkdir certs
        openssl req -newkey rsa:4096 -nodes -sha256 -keyout certs/ociregistry.key -addext "subjectAltName = DNS:${HNAME}" -x509 -days 365 -out certs/ociregistry.crt -subj "/C=DE/ST=Baden-Wuertemberg/L=Walldorf/O=SAP/OU=ocm/CN=${HNAME}"
        openssl x509 -noout -text -in certs/ociregistry.key
        sudo cp certs/ociregistry.crt /usr/local/share/ca-certificates
        sudo update-ca-certificates
    # - name: Test OCM
    #   run: ocm transfer artifacts gcr.io/google-containers/pause:3.2 ociregistry.local:5000/images/pause:3.2
